---
title: "Figure 7 Replication Code"
author: "Jane Pan"
date: "3/20/2022"
output: pdf_document
---

The following demo goes over different cases of the Bayesian assurance function using Adcock's precision error condition.

The function below returns the left-hand-side expression of the precision-based
solution for determining sample size discussed in Adcock (1997), with 1 - alpha
isolated on the right hand side.
```{r, echo = TRUE, include = TRUE}
library(bayesassurance)
```

```{r, echo = TRUE, include = TRUE}
adcock <- function(n, d, sig_sq){
  sigma <- sqrt(sig_sq)
  lhs <- 2 * pnorm(d / (sigma / sqrt(n))) - 1 
  
  # returns left hand side expression, right hand side is 1 - alpha
  return(lhs)
}
```

The function below performs the same steps as bayes_adcock() but returns only the left-hand-side 
expression of the assurance formula rather than computing the assurance. Here, 1 - alpha
is also isolated on the right hand side.
```{r, echo = TRUE, include = TRUE}
bayes_adcock_lhs <- function(n, d, mu_beta_a, mu_beta_d, n_a, n_d, sig_sq){

  count <- 0
  maxiter <- 1000
  lhs <- c()
  
  # Design Stage
  for(i in 1:maxiter){
    var_d <- sig_sq * ((n_d + n) / (n * n_d))
    xbar <- rnorm(n=1, mean = mu_beta_d, sd = sqrt(var_d))

    lambda <- ((n_a * mu_beta_a) + (n * xbar)) / (n_a + n)

    phi_1 <- (sqrt(n_a + n) / sqrt(sig_sq)) * (xbar + d - lambda)
    phi_2 <- (sqrt(n_a + n) / sqrt(sig_sq)) * (xbar - d - lambda)

    lhs <- c(lhs, pnorm(phi_1) - pnorm(phi_2))

  }

  lhs_avg <- mean(lhs)
  return(lhs_avg)
}
```


The next several blocks of code implement the above two functions for various assignments of
precision, d. The results should overlap one another perfectly when n_a = 0, as shown
in the figures. Figures are produced using ggplot2. 

## Case 1: d = 0.15
```{r, echo = FALSE, include = TRUE}
library(ggplot2)
n <- seq(5, 300, 5)
n_a <- n_d <- 1e-8
d <- 0.15
set.seed(1)
sig_sq <- runif(1, 0, 1)
mu_beta_d <- runif(1, 0, 1) 
mu_beta_a <- runif(1, 0, 1) 

lhs1 <- adcock(n, d, sig_sq)
lhs2 <- c()
for(i in n){
  lhs2 <- c(lhs2, bayes_adcock_lhs(n = i, d, mu_beta_a, mu_beta_d, n_a, n_d, sig_sq))
}


df1 <- as.data.frame(cbind(n, lhs1))
df2 <- as.data.frame(cbind(n, lhs2))

p <- ggplot(df1, alpha = 0.5, aes(x = n, y = lhs1, color="Adcock Cond"))
p <- p + geom_line(data = df1, alpha = 0.5, aes(x = n, y = lhs1, 
     color="Adcock Cond"), lwd = 1.2)

p1 <- p + geom_point(data = df2, alpha = 0.5, aes(x = n, y = lhs2, 
      color="Bayesian Sim"),lwd=1.2) + ylab("Probability of Meeting Analysis Objective") + 
      xlab("Sample Size n") + ggtitle("Comparison Between Adcock Conditiion and 
                                      Bayesian Simulation Results")


p1  <- p1 + geom_label(
      label="d = 0.15", 
      x=25,
      y=0.955,
      color = "black", size = 3
      )

p1

```

## Case 2: d = 0.10
```{r, echo = FALSE, include = TRUE}
library(ggplot2)
n <- seq(11, 300, 5)
n_a <- n_d <- 1e-8
d <- 0.10
set.seed(1)
sig_sq <- runif(1, 0, 1)
mu_beta_d <- runif(1, 0, 1) 
mu_beta_a <- 0

lhs1 <- adcock(n, d, sig_sq)
lhs2 <- c()
for(i in n){
  lhs2 <- c(lhs2, bayes_adcock_lhs(n = i, d, mu_beta_a, mu_beta_d, n_a, n_d, sig_sq))
}


df1 <- as.data.frame(cbind(n, lhs1))
df2 <- as.data.frame(cbind(n, lhs2))

p2 <- p1 + geom_line(data = df1, alpha = 0.5, aes(x = n, y = lhs1, color="Adcock Cond"), lwd = 1.2)

p3 <- p2 + geom_point(data = df2, alpha = 0.5, aes(x = n, y = lhs2, color="Bayesian Sim"),lwd=1.2) +
  ylab("Probability of Meeting Analysis Objective") + xlab("Sample Size n") + 
  ggtitle("Comparison Between Adcock Conditiion and Bayesian Simulation Results")


p3  <- p3 + geom_label(
      label="d = 0.10", 
      x= 60,
      y=0.925,
      color = "black", size = 3
      )

p3

```

## Case 3: d = 0.075
```{r, echo = FALSE, include = TRUE}
library(ggplot2)
n <- seq(20, 300, 5)
n_a <- n_d <- 1e-8
d <- 0.075
set.seed(1)
sig_sq <- runif(1, 0, 1)
mu_beta_d <- runif(1, 0, 1) 
mu_beta_a <- 0

lhs1 <- adcock(n, d, sig_sq)
lhs2 <- c()
for(i in n){
  lhs2 <- c(lhs2, bayes_adcock_lhs(n = i, d, mu_beta_a, mu_beta_d, n_a, n_d, sig_sq))
}


df1 <- as.data.frame(cbind(n, lhs1))
df2 <- as.data.frame(cbind(n, lhs2))

p4 <- p3 + geom_line(data = df1, alpha = 0.5, aes(x = n, y = lhs1, color="Adcock Cond"), lwd = 1.2)

p5 <- p4 + geom_point(data = df2, alpha = 0.5, aes(x = n, y = lhs2, color="Bayesian Sim"),lwd=1.2) +
  ylab("Probability of Meeting Analysis Objective") + xlab("Sample Size n") + 
  ggtitle("Comparison Between Adcock Conditiion and Bayesian Simulation Results")


p5  <- p5 + geom_label(
      label="d = 0.075", 
      x=100,
      y=0.9,
      color = "black", size = 3
      )

p5
```


## Case 4: d = 0.30
```{r, echo = FALSE, include = TRUE}
library(ggplot2)
n <- seq(20, 300, 5)
n_a <- n_d <- 1e-8
d <- 0.3
set.seed(1)
sig_sq <- runif(1, 0, 1)
mu_beta_d <- runif(1, 0, 1) 
mu_beta_a <- 0

lhs1 <- adcock(n, d, sig_sq)
lhs2 <- c()
for(i in n){
  lhs2 <- c(lhs2, bayes_adcock_lhs(n = i, d, mu_beta_a, mu_beta_d, n_a, n_d, sig_sq))
}


df1 <- as.data.frame(cbind(n, lhs1))
df2 <- as.data.frame(cbind(n, lhs2))

p6 <- p5 + geom_line(data = df1, alpha = 0.5, aes(x = n, y = lhs1, color="Adcock Cond"), lwd = 1.2)

p7 <- p6 + geom_point(data = df2, alpha = 0.5, aes(x = n, y = lhs2, color="Bayesian Sim"),lwd=1.2) +
  ylab("Probability of Meeting Analysis Objective") + xlab("Sample Size n") + 
  ggtitle("Comparison Between Adcock Conditiion and Bayesian Simulation Results")


p7  <- p7 + geom_label(
      label="d = 0.30", 
      x=20,
      y=1,
      color = "black", size = 3
      )

p7
```
